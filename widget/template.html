<!-- Related Brands (Auto) â€“ Page Builder Widget -->
<div class="bc-related-brands"
     data-max="{{settings.maxBrands}}"
     data-heading="{{settings.heading}}"
     data-override="{{settings.brandIdOverride}}">
  <h3 style="margin:0 0 12px;font-size:1.25rem;line-height:1.25;">{{settings.heading}}</h3>
  <ul style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;list-style:none;margin:0;padding:0;"></ul>
</div>

<script>
(function () {
  const root = document.currentScript.previousElementSibling;
  const max  = parseInt(root.getAttribute('data-max'), 10) || 12;
  const ul   = root.querySelector('ul');
  const dataUrl = "{{settings.dataUrl}}".replace(/\s+$/, '');
  const fallbackHeading = "Brands often found in the same categories";

  // Hide heading if blank
  (function() {
    const h = root.querySelector('h3');
    const txt = (root.getAttribute('data-heading') || '').trim();
    if (!txt) h.style.display = 'none';
  })();

  const s = {
    link: "display:grid;justify-items:center;text-align:center;text-decoration:none;color:inherit;",
    img:  "width:100px;height:auto;max-height:60px;object-fit:contain;margin-bottom:6px;",
    name: "font-size:0.9rem;line-height:1.2;"
  };

  function li(brand) {
    const li = document.createElement('li');
    const a  = document.createElement('a');
    a.href   = brand.path || (brand.custom_url && brand.custom_url.url) || ('/brands.php?brand_id=' + brand.id);
    a.setAttribute('style', s.link);
    if (brand.image_url) {
      const img = document.createElement('img');
      img.src = brand.image_url;
      img.alt = (brand.name || 'Brand') + ' logo';
      img.loading = 'lazy';
      img.setAttribute('style', s.img);
      a.appendChild(img);
    }
    const span = document.createElement('span');
    span.textContent = brand.name || ('Brand ' + brand.id);
    span.setAttribute('style', s.name);
    a.appendChild(span);
    li.appendChild(a);
    return li;
  }

  // ðŸ‘‡ NEW: read brand id from DOM first; then ?brand_id=. No GraphQL needed.
  function getBrandId() {
    // 1) DOM context (your div)
    const el = document.querySelector('[data-brand-id],[data-entity-id]');
    const attr = el && (el.getAttribute('data-brand-id') || el.getAttribute('data-entity-id'));
    if (attr && /^\d+$/.test(attr)) return Promise.resolve(parseInt(attr, 10));

    // 2) URL query (?brand_id=123)
    const sp = new URLSearchParams(location.search);
    const qId = sp.get('brand_id');
    if (qId && /^\d+$/.test(qId)) return Promise.resolve(parseInt(qId, 10));

    // 3) Nothing found
    return Promise.resolve(null);
  }

  function render(brands) {
    ul.innerHTML = '';
    (brands || []).slice(0, max).forEach(b => ul.appendChild(li(b)));
    if (!ul.children.length) {
      const h = root.querySelector('h3');
      if (h) h.textContent = fallbackHeading;
    }
  }

  function fetchJSON(u) {
    return fetch(u, { credentials: 'same-origin' }).then(r => r.ok ? r.json() : null).catch(() => null);
  }

  getBrandId().then(function(brandId){
    if (!brandId) return; // nothing to render
    fetchJSON(dataUrl).then(function(map){
      const list = map && map.byBrandId && map.byBrandId[String(brandId)];
      if (Array.isArray(list)) render(list);
    });
  });
})();
</script>

